<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <meta name="description" content="Source to the Rust file `src/settings/mod.rs`.">
    <meta name="keywords" content="rust, rustlang, rust-lang">

    <title>mod.rs.html -- source</title>

    <link rel="stylesheet" type="text/css" href="../../../normalize.css">
    <link rel="stylesheet" type="text/css" href="../../../rustdoc.css"
          id="mainThemeStyle">
    
    <link rel="stylesheet" type="text/css" href="../../../dark.css">
    <link rel="stylesheet" type="text/css" href="../../../main.css" id="themeStyle">
    <script src="../../../storage.js"></script>
    

    
    
</head>
<body class="rustdoc source">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <nav class="sidebar">
        <div class="sidebar-menu">&#9776;</div>
        
        
    </nav>

    <div class="theme-picker">
        <button id="theme-picker" aria-label="Pick another theme!">
            <img src="../../../brush.svg" width="18" alt="Pick another theme!">
        </button>
        <div id="theme-choices"></div>
    </div>
    <script src="../../../theme.js"></script>
    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press ‘S’ to search, ‘?’ for more options…"
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content"><pre class="line-numbers"><span id="1">  1</span>
<span id="2">  2</span>
<span id="3">  3</span>
<span id="4">  4</span>
<span id="5">  5</span>
<span id="6">  6</span>
<span id="7">  7</span>
<span id="8">  8</span>
<span id="9">  9</span>
<span id="10"> 10</span>
<span id="11"> 11</span>
<span id="12"> 12</span>
<span id="13"> 13</span>
<span id="14"> 14</span>
<span id="15"> 15</span>
<span id="16"> 16</span>
<span id="17"> 17</span>
<span id="18"> 18</span>
<span id="19"> 19</span>
<span id="20"> 20</span>
<span id="21"> 21</span>
<span id="22"> 22</span>
<span id="23"> 23</span>
<span id="24"> 24</span>
<span id="25"> 25</span>
<span id="26"> 26</span>
<span id="27"> 27</span>
<span id="28"> 28</span>
<span id="29"> 29</span>
<span id="30"> 30</span>
<span id="31"> 31</span>
<span id="32"> 32</span>
<span id="33"> 33</span>
<span id="34"> 34</span>
<span id="35"> 35</span>
<span id="36"> 36</span>
<span id="37"> 37</span>
<span id="38"> 38</span>
<span id="39"> 39</span>
<span id="40"> 40</span>
<span id="41"> 41</span>
<span id="42"> 42</span>
<span id="43"> 43</span>
<span id="44"> 44</span>
<span id="45"> 45</span>
<span id="46"> 46</span>
<span id="47"> 47</span>
<span id="48"> 48</span>
<span id="49"> 49</span>
<span id="50"> 50</span>
<span id="51"> 51</span>
<span id="52"> 52</span>
<span id="53"> 53</span>
<span id="54"> 54</span>
<span id="55"> 55</span>
<span id="56"> 56</span>
<span id="57"> 57</span>
<span id="58"> 58</span>
<span id="59"> 59</span>
<span id="60"> 60</span>
<span id="61"> 61</span>
<span id="62"> 62</span>
<span id="63"> 63</span>
<span id="64"> 64</span>
<span id="65"> 65</span>
<span id="66"> 66</span>
<span id="67"> 67</span>
<span id="68"> 68</span>
<span id="69"> 69</span>
<span id="70"> 70</span>
<span id="71"> 71</span>
<span id="72"> 72</span>
<span id="73"> 73</span>
<span id="74"> 74</span>
<span id="75"> 75</span>
<span id="76"> 76</span>
<span id="77"> 77</span>
<span id="78"> 78</span>
<span id="79"> 79</span>
<span id="80"> 80</span>
<span id="81"> 81</span>
<span id="82"> 82</span>
<span id="83"> 83</span>
<span id="84"> 84</span>
<span id="85"> 85</span>
<span id="86"> 86</span>
<span id="87"> 87</span>
<span id="88"> 88</span>
<span id="89"> 89</span>
<span id="90"> 90</span>
<span id="91"> 91</span>
<span id="92"> 92</span>
<span id="93"> 93</span>
<span id="94"> 94</span>
<span id="95"> 95</span>
<span id="96"> 96</span>
<span id="97"> 97</span>
<span id="98"> 98</span>
<span id="99"> 99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
</pre><pre class="rust ">
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">ini</span>;
<span class="kw">use</span> <span class="self">self</span>::<span class="ident">ini</span>::<span class="ident">Ini</span>;
<span class="kw">use</span> <span class="kw">super</span>::<span class="ident">http</span>;
<span class="kw">use</span> <span class="kw">super</span>::<span class="ident">AlarmRepeat</span>;
<span class="kw">use</span> <span class="kw">super</span>::<span class="ident">AlarmConfig</span>;
<span class="kw">use</span> <span class="kw">super</span>::<span class="ident">ConnectDeviceList</span>;
<span class="kw">use</span> <span class="kw">super</span>::<span class="ident">Scrobbler</span>;

<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">time</span>;
<span class="kw">extern</span> <span class="kw">crate</span> <span class="ident">fruitbasket</span>;

<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">env</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">path</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">str</span>::<span class="ident">FromStr</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">collections</span>::<span class="ident">BTreeMap</span>;

<span class="kw">const</span> <span class="ident">INIFILE</span>: <span class="kw-2">&amp;</span><span class="lifetime">&#39;static</span> <span class="ident">str</span> <span class="op">=</span> <span class="string">&quot;connectr.ini&quot;</span>;
<span class="kw">const</span> <span class="ident">PORT</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">5432</span>;
<span class="kw">pub</span> <span class="kw">const</span> <span class="ident">WEB_PORT</span>: <span class="ident">u32</span> <span class="op">=</span> <span class="number">5676</span>;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Default</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">LastfmSettings</span> {
    <span class="kw">pub</span> <span class="ident">key</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">secret</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">session_key</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">username</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">ignore_pc</span>: <span class="ident">bool</span>,
    <span class="kw">pub</span> <span class="ident">ignore_phone</span>: <span class="ident">bool</span>,
}

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Default</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">Settings</span> {
    <span class="kw">pub</span> <span class="ident">port</span>: <span class="ident">u32</span>,
    <span class="kw">pub</span> <span class="ident">secret</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">client_id</span>: <span class="ident">String</span>,
    <span class="kw">pub</span> <span class="ident">access_token</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">refresh_token</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">expire_utc</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">u64</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">presets</span>: <span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">String</span>,<span class="ident">String</span>)<span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">default_quicksave</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">String</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">quicksave</span>: <span class="ident">BTreeMap</span><span class="op">&lt;</span><span class="ident">String</span>, <span class="ident">String</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">alarms</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">AlarmConfig</span><span class="op">&gt;</span>,
    <span class="kw">pub</span> <span class="ident">lastfm_enabled</span>: <span class="ident">bool</span>,
    <span class="kw">pub</span> <span class="ident">lastfm</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">LastfmSettings</span><span class="op">&gt;</span>,
}

<span class="kw">impl</span> <span class="ident">Settings</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">quick_save_playlist</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">context</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>) <span class="op">-&gt;</span> <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">str</span><span class="op">&gt;</span> {
        <span class="kw">match</span> <span class="self">self</span>.<span class="ident">quicksave</span>.<span class="ident">get</span>(<span class="ident">context</span>) {
            <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">uri</span>) <span class="op">=&gt;</span> <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span><span class="ident">uri</span>),
            <span class="prelude-val">None</span> <span class="op">=&gt;</span> {
                <span class="kw">match</span> <span class="self">self</span>.<span class="ident">default_quicksave</span> {
                    <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">uri</span>) <span class="op">=&gt;</span> <span class="prelude-val">Some</span>(<span class="kw-2">&amp;</span><span class="ident">uri</span>),
                    <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="prelude-val">None</span>,
                }
            }
        }
    }
}

<span class="kw">fn</span> <span class="ident">default_inifile</span>() <span class="op">-&gt;</span> <span class="ident">String</span> {
    <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{}/.{}&quot;</span>, <span class="ident">env</span>::<span class="ident">home_dir</span>().<span class="ident">unwrap</span>().<span class="ident">display</span>(), <span class="ident">INIFILE</span>)
}

<span class="kw">fn</span> <span class="ident">inifile</span>() <span class="op">-&gt;</span> <span class="ident">String</span> {
    <span class="comment">// Try to load INI file from home directory</span>
    <span class="kw">let</span> <span class="ident">path</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{}/.{}&quot;</span>, <span class="ident">env</span>::<span class="ident">home_dir</span>().<span class="ident">unwrap</span>().<span class="ident">display</span>(), <span class="ident">INIFILE</span>);
    <span class="kw">if</span> <span class="ident">path</span>::<span class="ident">Path</span>::<span class="ident">new</span>(<span class="kw-2">&amp;</span><span class="ident">path</span>).<span class="ident">exists</span>() {
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Found config: {}&quot;</span>, <span class="ident">path</span>);
        <span class="kw">return</span> <span class="ident">path</span>;
    }

    <span class="comment">// Default to looking in current working directory</span>
    <span class="kw">let</span> <span class="ident">path</span> <span class="op">=</span> <span class="ident">INIFILE</span>.<span class="ident">to_string</span>();
    <span class="kw">if</span> <span class="ident">path</span>::<span class="ident">Path</span>::<span class="ident">new</span>(<span class="kw-2">&amp;</span><span class="ident">path</span>).<span class="ident">exists</span>() {
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Found config: {}&quot;</span>, <span class="ident">path</span>);
        <span class="kw">return</span> <span class="ident">path</span>;
    }

    <span class="ident">String</span>::<span class="ident">new</span>()
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">request_web_config</span>(<span class="ident">settings</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">Settings</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="ident">BTreeMap</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">form</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
{}
&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;no-cache&quot; /&gt;&lt;meta http-equiv=&quot;expires&quot; content=&quot;0&quot;&gt;&lt;/head&gt;
&lt;head&gt;&lt;title&gt;Connectr Installation&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;h2&gt;Connectr Installation&lt;/h2&gt;
Connectr requires a &lt;em&gt;paid&lt;/em&gt; Spotify Premium account and a &lt;em&gt;free&lt;/em&gt; Spotify developer application.&lt;/br&gt;
If you don&#39;t have a Premium account, perhaps try a &lt;a href=&quot;https://www.spotify.com/us/premium/&quot;&gt;free trial&lt;/a&gt;.&lt;/br&gt;
&lt;/br&gt;
To create your free developer application for Connectr, follow these instructions:&lt;/br&gt;
&lt;p&gt;&lt;ul&gt;
&lt;li&gt; Go to your &lt;a href=&quot;https://developer.spotify.com/my-applications/#!/applications/create&quot;&gt;Spotify Applications&lt;/a&gt; page (login with your Spotify credentials)
&lt;li&gt; Click &quot;CREATE AN APP&quot; in the upper-right corner
&lt;li&gt; Enter a name (perhaps &#39;Connectr&#39;) and description (&quot;Use Connectr app with my account.&quot;)
&lt;li&gt; Add a Redirect URI: &lt;em&gt;http://127.0.0.1:{}&lt;/em&gt;
&lt;li&gt; Copy your &lt;em&gt;Client ID&lt;/em&gt; and &lt;em&gt;Client Secret&lt;/em&gt; to the fields below.
&lt;li&gt; Press the &lt;em&gt;SAVE&lt;/em&gt; button at the bottom of Spotify&#39;s webpage
&lt;li&gt; Submit this configuration form
&lt;/ul&gt;&lt;/p&gt;
&lt;form method=&quot;POST&quot; action=&quot;#&quot; accept-charset=&quot;UTF-8&quot;&gt;&lt;table&gt;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;h3&gt;Spotify Credentials (all fields required):&lt;/h3&gt;&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>,
                           <span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\nCache-Control: no-cache, no-store, must-revalidate, max-age=0\r\n\r\n&quot;</span>,
                           <span class="ident">PORT</span>);
    <span class="kw">let</span> <span class="ident">client_id</span> <span class="op">=</span> <span class="ident">settings</span>.<span class="ident">map_or</span>(<span class="string">&quot;&quot;</span>, <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="kw-2">&amp;</span><span class="ident">s</span>.<span class="ident">client_id</span>);
    <span class="kw">let</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">settings</span>.<span class="ident">map_or</span>(<span class="string">&quot;&quot;</span>, <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="kw-2">&amp;</span><span class="ident">s</span>.<span class="ident">secret</span>);
    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td&gt;Client ID:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;client_id&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Client Secret:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;secret&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>,
                           <span class="ident">client_id</span>, <span class="comment">// client id</span>
                           <span class="ident">secret</span> <span class="comment">// secret</span>
                           ));
    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;/br&gt;&lt;/br&gt;&lt;/tr&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;h3&gt;Presets (all fields optional):&lt;/h3&gt;
    &lt;div style=&quot;width:600px;&quot;&gt;
    Presets let you start your favorite Spotify contexts (playlist, album, artist, etc) from Connectr.
    You can add an optional &quot;quick save&quot; playlist for each preset, to quickly save tracks you like to a known playlist.
    For instance, you might have a &quot;Discover Weekly&quot; preset, and a quick save to a &quot;Best of Discover Weekly&quot; playlist.
    You can also set a global &quot;quick save&quot; playlist, where tracks are saved if not playing from a preset with an associated quick-save playlist.&lt;/br&gt;
    &lt;/br&gt;
    All contexts must be specified in Spotify&#39;s URI format: ex: &lt;code&gt;spotify:album:2p2UgYlbg4yG44IKDp08Q8&lt;/code&gt;
    &lt;/div&gt;
    &lt;/br&gt;
    One preset per line, in either format::&lt;/br&gt;
    &amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;code&gt;[Preset Name] = [Context URI]&lt;/code&gt;&lt;/br&gt;
    &amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;code&gt;[Preset Name] = [Context URI],[Quick-save Playlist URI]&lt;/code&gt;
    &lt;/br&gt;&lt;/br&gt;
&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>));
    <span class="kw">let</span> <span class="ident">presets</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">settings</span> {
        <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">settings</span>) <span class="op">=&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">p</span> <span class="op">=</span> <span class="ident">String</span>::<span class="ident">new</span>();
            <span class="kw">for</span> <span class="kw-2">&amp;</span>(<span class="kw-2">ref</span> <span class="ident">name</span>, <span class="kw-2">ref</span> <span class="ident">uri</span>) <span class="kw">in</span> <span class="kw-2">&amp;</span><span class="ident">settings</span>.<span class="ident">presets</span> {
                <span class="kw">let</span> <span class="ident">qsave</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">settings</span>.<span class="ident">quicksave</span>.<span class="ident">get</span>(<span class="ident">uri</span>) {
                    <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">q</span>) <span class="op">=&gt;</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;,{}&quot;</span>, <span class="ident">q</span>),
                    <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
                };
                <span class="ident">p</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{} = {}{}&quot;</span>, <span class="ident">name</span>, <span class="ident">uri</span>, <span class="ident">qsave</span>));
            }
            <span class="ident">p</span>
        },
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
    };
    <span class="kw">let</span> <span class="ident">quicksave</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">settings</span> {
        <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">s</span>) <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">s</span>.<span class="ident">default_quicksave</span> {
            <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">d</span>) <span class="op">=&gt;</span> <span class="kw-2">&amp;</span><span class="ident">d</span>,
            <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>,
        },
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>,
    };
    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td&gt;Presets:&lt;/br&gt;(one per line)&lt;/td&gt;&lt;td&gt;&lt;textarea rows=&quot;10&quot; cols=&quot;100&quot;  name=&quot;presets&quot; placeholder=&quot;First Preset Name = spotify:user:spotify:playlist:37i9dQZEVXboyJ0IJdpcuT&quot;&gt;{}&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;width:200px;&quot;&gt;Quick-Save URI:&lt;/br&gt;(playlist URI)&lt;/td&gt;&lt;td&gt;
    &lt;input type=&quot;text&quot; name=&quot;quicksave_default&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>,
                           <span class="ident">presets</span>, <span class="comment">// Preset list</span>
                           <span class="ident">quicksave</span>, <span class="comment">// quicksave default</span>
    ));

    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;/br&gt;&lt;/br&gt;&lt;/tr&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;h3&gt;Last.fm Scrobbling (optional):&lt;/h3&gt;
    &lt;div style=&quot;width:600px;&quot;&gt;
    Enable Scrobbling to &lt;a href=&quot;https://last.fm&quot;&gt;Last.fm&lt;/a&gt;.  If enabled, Connectr will scrobble any tracks that it sees playing on your Spotify account.  Note that Connectr must be running and online to scrobble, so this feature is most useful when Connectr is hosted on an always-on server like a home media machine or a VPS.&lt;/br&gt;&lt;/br&gt;
    This whole section is optional, but all fields are required if any of them are specified.&lt;/br&gt;&lt;/br&gt;
    Scrobbling requires a Last.fm account (free) and a developer API key (also free).  After you have signed up, you can &lt;a href=&quot;https://www.last.fm/api/account/create&quot;&gt;request an API key here&lt;/a&gt;.&lt;/br&gt;&lt;/br&gt;
    Spotify&#39;s desktop and mobile clients have Last.fm scrobbling built in, while Spotify Connect devices like speakers and TVs do not.  Below you can set whether you want Connectr to ignore (not scrobble) certain classes of devices.  This is especially handy for mobile devices, which can scrobble tracks that were played offline.&lt;/br&gt;&lt;/br&gt;
    &lt;/div&gt;
&quot;###</span>));

    <span class="kw">let</span> <span class="ident">enabled</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">settings</span> {
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="bool-val">false</span>,
        <span class="prelude-val">Some</span>(<span class="ident">settings</span>) <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">settings</span>.<span class="ident">lastfm</span> {
            <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="bool-val">false</span>,
            <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">settings</span>.<span class="ident">lastfm_enabled</span> {
                <span class="bool-val">false</span> <span class="op">=&gt;</span> <span class="bool-val">false</span>,
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="bool-val">true</span>,
            }
        }
    };
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">String</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">String</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">username</span> <span class="op">=</span> <span class="ident">String</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">password</span> <span class="op">=</span> <span class="ident">String</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ignore_pc</span>: <span class="kw-2">&amp;</span><span class="ident">str</span> <span class="op">=</span> <span class="string">&quot;&quot;</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ignore_phone</span>: <span class="kw-2">&amp;</span><span class="ident">str</span> <span class="op">=</span> <span class="string">&quot;&quot;</span>;
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">settings</span>) <span class="op">=</span> <span class="ident">settings</span> {
        <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">lastfm</span>) <span class="op">=</span> <span class="ident">settings</span>.<span class="ident">lastfm</span> {
            <span class="ident">key</span> <span class="op">=</span> <span class="ident">lastfm</span>.<span class="ident">key</span>.<span class="ident">clone</span>();
            <span class="ident">secret</span> <span class="op">=</span> <span class="ident">lastfm</span>.<span class="ident">secret</span>.<span class="ident">clone</span>();
            <span class="ident">username</span> <span class="op">=</span> <span class="ident">lastfm</span>.<span class="ident">username</span>.<span class="ident">clone</span>();
            <span class="ident">password</span> <span class="op">=</span> <span class="string">&quot;&lt;UNCHANGED&gt;&quot;</span>.<span class="ident">to_string</span>();
            <span class="ident">ignore_pc</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">lastfm</span>.<span class="ident">ignore_pc</span> {
                <span class="bool-val">false</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>,
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;checked&quot;</span>,
            };
            <span class="ident">ignore_phone</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">lastfm</span>.<span class="ident">ignore_phone</span> {
                <span class="bool-val">false</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>,
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;checked&quot;</span>,
            };
        }
    }
    <span class="kw">let</span> <span class="ident">enabled</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">enabled</span> {
        <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;checked&quot;</span>,
        <span class="bool-val">false</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>,
    };
    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td&gt;Scrobbling enabled:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;lastfm_enabled&quot; {}&gt;&lt;/input&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;width: 200px;&quot;&gt;Last.fm API key:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;lastfm_key&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Last.fm API Secret:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;lastfm_secret&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Last.fm username:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;lastfm_username&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Last.fm password:&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;lastfm_password&quot; value=&quot;{}&quot; style=&quot;width:400px;&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Ignore device types:&lt;/td&gt;
&lt;td&gt;
&lt;input type=&quot;checkbox&quot; name=&quot;lastfm_ignore_pc&quot; {}&gt; Computers&lt;/input&gt;&lt;/br&gt;
&lt;input type=&quot;checkbox&quot; name=&quot;lastfm_ignore_phone&quot; {}&gt; Smartphones&lt;/input&gt;&lt;/br&gt;
&lt;/td&gt;
&lt;/tr&gt;
&quot;###</span>,
    <span class="ident">enabled</span>, <span class="ident">key</span>, <span class="ident">secret</span>, <span class="ident">username</span>, <span class="ident">password</span>, <span class="ident">ignore_pc</span>, <span class="ident">ignore_phone</span>));

    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(<span class="string">r###&quot;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;/br&gt;&lt;/br&gt;&lt;/tr&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td colspan=2&gt;&lt;center&gt;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;Cancel&quot; style=&quot;height:50px; width: 300px; font-size:20px;&quot;&gt; &amp;nbsp; &lt;input type=&quot;submit&quot; value=&quot;Save Configuration&quot; style=&quot;height:50px; width: 300px; font-size:20px;&quot;&gt;&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;
&lt;/br&gt;
&lt;/table&gt;&lt;/form&gt;
&lt;/br&gt;
&lt;small&gt;Config will be saved as: &lt;em&gt;{}&lt;/em&gt;&lt;/br&gt;
If something goes wrong or changes, edit or delete that file.&lt;/small&gt;
&lt;/body&gt;&lt;/html&gt;
&quot;###</span>,
                           <span class="ident">default_inifile</span>()));
    <span class="kw">let</span> <span class="ident">reply</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{}Configuration saved.  You can close this window.&quot;</span>,
                        <span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\n\r\n&quot;</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">config</span> <span class="op">=</span> <span class="ident">BTreeMap</span>::<span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span>::<span class="ident">new</span>();
    <span class="ident">config</span>.<span class="ident">insert</span>(<span class="string">&quot;port&quot;</span>.<span class="ident">to_string</span>(), <span class="ident">PORT</span>.<span class="ident">to_string</span>());
    <span class="ident">config</span>.<span class="ident">append</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">http</span>::<span class="ident">config_request_local_webserver</span>(<span class="ident">WEB_PORT</span>, <span class="ident">form</span>, <span class="ident">reply</span>));
    <span class="ident">config</span>
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">request_web_alarm_config</span>(<span class="ident">alarms</span>: <span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">AlarmConfig</span><span class="op">&gt;</span>,
                                <span class="ident">devices</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">ConnectDeviceList</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="ident">BTreeMap</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">form</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(
        <span class="string">r###&quot;
{}
&lt;!DOCTYPE HTML&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Connectr Alarm Clocks&lt;/title&gt;&lt;style&gt;
tr:nth-child(even) {{ background: #f2f2f2; }}
th {{ width:120px;border-bottom: 1px solid #ddd; }}
a.tooltip {{ position: relative; }}
a.tooltip::before {{ content: attr(data-tip); position:absolute; z-index: 999;
white-space:normal; bottom:9999px; left: 50%; background:#000; color:#e0e0e0;
padding:2px 7px 2px 7px; line-height: 16px; opacity: 0; width: inherit; max-width: 500px;
transition:opacity 0.4s ease-out; font-weight: normal; text-align: left; min-width: 100px; }}
a.tooltip:hover::before {{ opacity: 1; bottom:-35px; }}
a.tooltip {{ color: #4e4e4e; text-decoration: none; vertical-align: super; font-size: 11px; font-weight: normal; }}
&lt;/style&gt;
&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;no-cache&quot; /&gt;&lt;meta http-equiv=&quot;expires&quot; content=&quot;0&quot;&gt;&lt;/head&gt;
&lt;body&gt;&lt;h2&gt;Connectr Alarm Clocks&lt;/h2&gt;
    &lt;div style=&quot;background-color: #9e9e9e; padding: 10px 10px 10px 10px;&quot;&gt;&lt;strong&gt;IMPORTANT:&lt;/strong&gt; Do NOT close this window without saving or cancelling.  Connectr is paused internally until this is dismissed!&lt;/div&gt;&lt;br/&gt;
    &lt;h3&gt;Connected Devices: &lt;a href=&quot;#&quot; style=&quot;width: 300px;&quot; class=&quot;tooltip&quot; data-tip=&quot;These are the devices that are currently logged in and online.  You can specify any device for your alarm, but be sure it is on and logged in at the right time.  Make sure your device doesn&#39;t become unavailable when idle.&quot;&gt;eh?&lt;/a&gt;&lt;/h3&gt;
    &lt;table&gt;&lt;tr&gt;&lt;th style=&quot;width:300px;&quot;&gt;Name&lt;/th&gt;&lt;th&gt;Device ID&lt;/th&gt;&lt;/tr&gt;
&quot;###</span>,
        <span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\nCache-Control: no-cache, no-store, must-revalidate, max-age=0\r\n\r\n&quot;</span>);
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">devices</span>) <span class="op">=</span> <span class="ident">devices</span> {
        <span class="kw">for</span> <span class="ident">dev</span> <span class="kw">in</span> <span class="ident">devices</span> {
            <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(
                <span class="string">r###&quot;
      &lt;tr&gt;&lt;td&gt;{}&lt;/td&gt;&lt;td&gt;{}&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>, <span class="ident">dev</span>.<span class="ident">name</span>, <span class="ident">dev</span>.<span class="ident">id</span>.<span class="ident">as_ref</span>().<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;unknown&quot;</span>.<span class="ident">to_string</span>())));
        }
    }
    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(
    <span class="string">r###&quot;
    &lt;/table&gt;&lt;br/&gt;
    &lt;h3&gt;Alarm Schedule:&lt;/h3&gt;
&lt;form method=&quot;POST&quot; action=&quot;#&quot; accept-charset=&quot;UTF-8&quot;&gt;&lt;table&gt;
&lt;tr&gt;&lt;th align=&quot;center&quot;&gt;Time &lt;a href=&quot;#&quot; class=&quot;tooltip&quot; data-tip=&quot;24-hour format&quot;&gt;eh?&lt;/a&gt;&lt;/th&gt;&lt;th align=&quot;center&quot;&gt;Repeat&lt;/th&gt;&lt;th&gt;Spotify URI &lt;a href=&quot;#&quot; class=&quot;tooltip&quot; data-tip=&quot;In Spotify app: right-click playlist, click &#39;Share&#39;, click &#39;URI&#39;&quot;&gt;eh?&lt;/a&gt;&lt;/th&gt;&lt;th&gt;Device ID &lt;a href=&quot;#&quot; class=&quot;tooltip&quot; data-tip=&quot;Unique identifier of Spotify hardware.  Devices are listed above.&quot;&gt;eh?&lt;/a&gt;&lt;/th&gt;&lt;/tr&gt;
&quot;###</span>));
    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="number">5</span> {
        <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(
            <span class="string">r###&quot;
&lt;tr&gt;&lt;td align=&quot;center&quot;&gt;&lt;input style=&quot;width:40px;&quot; type=&quot;number&quot; name=&quot;hour_{}&quot; min=&quot;0&quot; max=&quot;23&quot; size=&quot;3&quot; maxlength=&quot;2&quot; value=&quot;{}&quot;&gt;:&lt;input style=&quot;width:40px;&quot; type=&quot;number&quot; name=&quot;minute_{}&quot; min=&quot;0&quot; max=&quot;59&quot; size=&quot;3&quot; maxlength=&quot;2&quot; value=&quot;{}&quot;&gt;&lt;/td&gt;&lt;td align=&quot;center&quot;&gt;&lt;select name=&quot;repeat_{}&quot;&gt;&lt;option value=&quot;daily&quot; {}&gt;Daily&lt;/option&gt;&lt;option value=&quot;weekdays&quot; {}&gt;Weekdays&lt;/option&gt;&lt;option value=&quot;weekends&quot; {}&gt;Weekends&lt;/option&gt;&lt;/select&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;context_{}&quot; style=&quot;width:350px;&quot; value=&quot;{}&quot;&gt;&lt;/td&gt;&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;device_{}&quot; size=&quot;42&quot; value=&quot;{}&quot;&gt;&lt;/td&gt;&lt;/tr&gt;
&quot;###</span>,
            <span class="ident">i</span>,
            <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="number">0</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="ident">a</span>.<span class="ident">hour</span>}).<span class="ident">to_string</span>(),
            <span class="ident">i</span>,
            <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="number">0</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="ident">a</span>.<span class="ident">minute</span>}).<span class="ident">to_string</span>(),
            <span class="ident">i</span>,
            <span class="kw">match</span> <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="bool-val">false</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="ident">a</span>.<span class="ident">repeat</span> <span class="op">==</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Daily</span>   }) {
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;selected&quot;</span>, <span class="kw">_</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span> },
            <span class="kw">match</span> <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="bool-val">false</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="ident">a</span>.<span class="ident">repeat</span> <span class="op">==</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Weekdays</span>}) {
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;selected&quot;</span>, <span class="kw">_</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>},
            <span class="kw">match</span> <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="bool-val">false</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="ident">a</span>.<span class="ident">repeat</span> <span class="op">==</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Weekends</span>}) {
                <span class="bool-val">true</span> <span class="op">=&gt;</span> <span class="string">&quot;selected&quot;</span>, <span class="kw">_</span> <span class="op">=&gt;</span> <span class="string">&quot;&quot;</span>},
            <span class="ident">i</span>,
            <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="string">&quot;&quot;</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="kw-2">&amp;</span><span class="ident">a</span>.<span class="ident">context</span>}),
            <span class="ident">i</span>,
            <span class="ident">alarms</span>.<span class="ident">get</span>(<span class="ident">i</span>).<span class="ident">map_or</span>(<span class="string">&quot;&quot;</span>, <span class="op">|</span><span class="ident">a</span><span class="op">|</span> {<span class="kw-2">&amp;</span><span class="ident">a</span>.<span class="ident">device</span>}),
        ));
    }

    <span class="ident">form</span>.<span class="ident">push_str</span>(<span class="kw-2">&amp;</span><span class="macro">format</span><span class="macro">!</span>(
        <span class="string">r###&quot;
&lt;tr&gt;&lt;td colspan=&quot;4&quot;&gt;&lt;br/&gt;&lt;center&gt;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;Cancel&quot; style=&quot;height:50px; width: 300px; font-size:20px;&quot;&gt; &amp;nbsp; &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Save Configuration&quot; style=&quot;height:50px; width: 300px; font-size:20px;&quot;&gt;&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/br&gt;
&lt;/table&gt;&lt;/form&gt;
&lt;br/&gt;&lt;small&gt;You can manually change or add more alarms by editing: &lt;em&gt;{}&lt;/em&gt;&lt;/br&gt;&lt;/br&gt;
It is wise to have a backup alarm, in case your internet or Spotify is down.&lt;/small&gt;
&lt;/body&gt;&lt;/html&gt;
&quot;###</span>, <span class="ident">inifile</span>()));

    <span class="kw">let</span> <span class="ident">reply</span> <span class="op">=</span> <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{}Configuration saved.  You can close this window.&quot;</span>,
                        <span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/html; charset=utf-8\r\n\r\n&quot;</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">config</span> <span class="op">=</span> <span class="ident">BTreeMap</span>::<span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span>::<span class="ident">new</span>();
    <span class="ident">config</span>.<span class="ident">append</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">http</span>::<span class="ident">config_request_local_webserver</span>(<span class="ident">WEB_PORT</span>, <span class="ident">form</span>, <span class="ident">reply</span>));
    <span class="ident">config</span>
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">save_web_config</span>(<span class="ident">old_settings</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">Settings</span><span class="op">&gt;</span>, <span class="kw-2">mut</span> <span class="ident">config</span>: <span class="ident">BTreeMap</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="ident">Ini</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">c</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">old_settings</span> {
        <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="ident">Ini</span>::<span class="ident">load_from_file</span>(<span class="kw-2">&amp;</span><span class="ident">inifile</span>()).<span class="ident">unwrap_or</span>(<span class="ident">Ini</span>::<span class="ident">new</span>()),
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">Ini</span>::<span class="ident">new</span>(),
    };
    <span class="kw">if</span> <span class="ident">config</span>.<span class="ident">contains_key</span>(<span class="string">&quot;cancel&quot;</span>) {
        <span class="kw">return</span> <span class="ident">c</span>;
    }
    <span class="kw">let</span> <span class="ident">port</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;port&quot;</span>).<span class="ident">unwrap</span>();
    <span class="ident">c</span>.<span class="ident">with_section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;connectr&quot;</span>.<span class="ident">to_owned</span>()))
        .<span class="ident">set</span>(<span class="string">&quot;port&quot;</span>, <span class="ident">port</span>);
    <span class="kw">let</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;secret&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&lt;PLACEHOLDER&gt;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">client_id</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;client_id&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&lt;PLACEHOLDER&gt;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">presets</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;presets&quot;</span>).<span class="ident">unwrap_or</span>(<span class="ident">String</span>::<span class="ident">new</span>());
    <span class="ident">c</span>.<span class="ident">with_section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;application&quot;</span>.<span class="ident">to_owned</span>()))
        .<span class="ident">set</span>(<span class="string">&quot;secret&quot;</span>, <span class="ident">secret</span>.<span class="ident">trim</span>())
        .<span class="ident">set</span>(<span class="string">&quot;client_id&quot;</span>, <span class="ident">client_id</span>.<span class="ident">trim</span>());
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">quicksave</span>) <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;quicksave_default&quot;</span>) {
        <span class="ident">c</span>.<span class="ident">with_section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;connectr&quot;</span>.<span class="ident">to_owned</span>()))
            .<span class="ident">set</span>(<span class="string">&quot;quicksave_default&quot;</span>, <span class="ident">quicksave</span>.<span class="ident">trim</span>());
    }
    {
        <span class="comment">// TODO: INI uses HashMap, doesn&#39;t support maintaining order</span>
        <span class="kw">for</span> <span class="ident">preset</span> <span class="kw">in</span> <span class="ident">presets</span>.<span class="ident">split</span>(<span class="string">&quot;\n&quot;</span>) {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">pair</span> <span class="op">=</span> <span class="ident">preset</span>.<span class="ident">split</span>(<span class="string">&quot;=&quot;</span>);
            <span class="kw">if</span> <span class="ident">pair</span>.<span class="ident">clone</span>().<span class="ident">count</span>() <span class="op">==</span> <span class="number">2</span> {
                <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">pair</span>.<span class="ident">next</span>().<span class="ident">unwrap</span>().<span class="ident">trim</span>();
                <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="ident">pair</span>.<span class="ident">next</span>().<span class="ident">unwrap</span>().<span class="ident">trim</span>();
                <span class="ident">c</span>.<span class="ident">set_to</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;presets&quot;</span>), <span class="ident">key</span>.<span class="ident">to_string</span>(), <span class="ident">value</span>.<span class="ident">to_string</span>());
            }
        }
    }
    <span class="kw">let</span> <span class="ident">lastfm_enabled</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_enabled&quot;</span>) {
        <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="bool-val">true</span>,
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="bool-val">false</span>,
    };
    <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_key&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_secret&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">username</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_username&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">password</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_password&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>());
    <span class="kw">let</span> <span class="ident">session_key</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">password</span>.<span class="ident">as_str</span>() {
        <span class="string">&quot;&lt;UNCHANGED&gt;&quot;</span> <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">old_settings</span> {
            <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">settings</span>) <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">settings</span>.<span class="ident">lastfm</span> {
                <span class="prelude-val">Some</span>(<span class="kw-2">ref</span> <span class="ident">fm</span>) <span class="op">=&gt;</span> <span class="ident">fm</span>.<span class="ident">session_key</span>.<span class="ident">clone</span>(),
                <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
            },
            <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
        },
        <span class="kw">_</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
    };
    <span class="kw">let</span> <span class="ident">ignore_pc</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_ignore_pc&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()) <span class="op">!=</span> <span class="string">&quot;&quot;</span>;
    <span class="kw">let</span> <span class="ident">ignore_phone</span> <span class="op">=</span> <span class="ident">config</span>.<span class="ident">remove</span>(<span class="string">&quot;lastfm_ignore_phone&quot;</span>).<span class="ident">unwrap_or</span>(<span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()) <span class="op">!=</span> <span class="string">&quot;&quot;</span>;
    <span class="comment">// Use existing session key if it exists, otherwise calculate a new one from</span>
    <span class="comment">// the password.</span>
    <span class="kw">let</span> <span class="ident">session_key</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">session_key</span>.<span class="ident">len</span>() {
        <span class="number">0</span> <span class="op">=&gt;</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">scrob</span> <span class="op">=</span> <span class="ident">Scrobbler</span>::<span class="ident">new</span>(<span class="ident">key</span>.<span class="ident">to_owned</span>(), <span class="ident">secret</span>.<span class="ident">to_owned</span>());
            <span class="kw">match</span> <span class="ident">scrob</span>.<span class="ident">authenticate_with_password</span>(<span class="ident">username</span>.<span class="ident">to_owned</span>(), <span class="ident">password</span>.<span class="ident">to_owned</span>()) {
                <span class="prelude-val">Ok</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="kw">match</span> <span class="ident">scrob</span>.<span class="ident">session_key</span>() {
                    <span class="prelude-val">Some</span>(<span class="ident">key</span>) <span class="op">=&gt;</span> <span class="ident">key</span>,
                    <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
                },
                <span class="prelude-val">Err</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="ident">String</span>::<span class="ident">new</span>(),
            }
        },
        <span class="kw">_</span> <span class="op">=&gt;</span> <span class="ident">session_key</span>,
    };
    <span class="ident">c</span>.<span class="ident">with_section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;lastfm&quot;</span>.<span class="ident">to_owned</span>()))
        .<span class="ident">set</span>(<span class="string">&quot;enabled&quot;</span>, <span class="ident">lastfm_enabled</span>.<span class="ident">to_string</span>())
        .<span class="ident">set</span>(<span class="string">&quot;key&quot;</span>, <span class="ident">key</span>.<span class="ident">trim</span>())
        .<span class="ident">set</span>(<span class="string">&quot;secret&quot;</span>, <span class="ident">secret</span>.<span class="ident">trim</span>())
        .<span class="ident">set</span>(<span class="string">&quot;session_key&quot;</span>, <span class="ident">session_key</span>)
        .<span class="ident">set</span>(<span class="string">&quot;username&quot;</span>, <span class="ident">username</span>.<span class="ident">trim</span>())
        .<span class="ident">set</span>(<span class="string">&quot;ignore_pc&quot;</span>, <span class="ident">ignore_pc</span>.<span class="ident">to_string</span>())
        .<span class="ident">set</span>(<span class="string">&quot;ignore_phone&quot;</span>, <span class="ident">ignore_phone</span>.<span class="ident">to_string</span>());
    <span class="ident">c</span>.<span class="ident">write_to_file</span>(<span class="kw-2">&amp;</span><span class="ident">default_inifile</span>()).<span class="ident">unwrap</span>();
    <span class="ident">c</span>
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">save_web_alarm_config</span>(<span class="ident">config</span>: <span class="ident">BTreeMap</span><span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span>(), <span class="ident">SettingsError</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">file</span> <span class="op">=</span> <span class="ident">inifile</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">conf</span>: <span class="ident">Ini</span>;
    <span class="kw">match</span> <span class="ident">Ini</span>::<span class="ident">load_from_file</span>(<span class="kw-2">&amp;</span><span class="ident">file</span>) {
        <span class="prelude-val">Ok</span>(<span class="ident">c</span>) <span class="op">=&gt;</span> <span class="ident">conf</span> <span class="op">=</span> <span class="ident">c</span>,
        <span class="prelude-val">Err</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="string">&quot;Couldn&#39;t open configuration.&quot;</span>.<span class="ident">to_string</span>()),
    }
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">entries</span>: <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">AlarmConfig</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">with_capacity</span>(<span class="number">5</span>);
    <span class="kw">for</span> <span class="kw">_</span> <span class="kw">in</span> <span class="number">0</span>..<span class="number">5</span> {
        <span class="ident">entries</span>.<span class="ident">push</span>(<span class="ident">Default</span>::<span class="ident">default</span>());
    }
    <span class="kw">for</span> <span class="ident">pair</span> <span class="kw">in</span> <span class="ident">config</span>.<span class="ident">iter</span>() {
        <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">pair</span>.<span class="number">0</span>;
        <span class="kw">let</span> <span class="ident">value</span> <span class="op">=</span> <span class="ident">pair</span>.<span class="number">1</span>;
        <span class="kw">if</span> <span class="ident">key</span> <span class="op">==</span> <span class="string">&quot;cancel&quot;</span> {
            <span class="kw">return</span> <span class="prelude-val">Err</span>(<span class="string">&quot;Canceled by user.&quot;</span>.<span class="ident">to_string</span>());
        }
        <span class="comment">// Clear existing alarms</span>
        <span class="ident">conf</span>.<span class="ident">delete</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;alarms&quot;</span>.<span class="ident">to_owned</span>()));
        <span class="comment">// are you kidding me??</span>
        <span class="kw">let</span> <span class="ident">idx</span> <span class="op">=</span> <span class="ident">key</span>.<span class="ident">chars</span>().<span class="ident">rev</span>().<span class="ident">take</span>(<span class="number">1</span>).<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">char</span><span class="op">&gt;&gt;</span>()[<span class="number">0</span>].<span class="ident">to_digit</span>(<span class="number">10</span>).<span class="ident">unwrap_or</span>(<span class="number">0</span>) <span class="kw">as</span> <span class="ident">usize</span>;
        <span class="kw">let</span> <span class="ident">entry</span> <span class="op">=</span> <span class="ident">entries</span>.<span class="ident">get_mut</span>(<span class="ident">idx</span>).<span class="ident">unwrap</span>();
        <span class="kw">match</span> <span class="ident">key</span>.<span class="ident">split</span>(<span class="string">&quot;_&quot;</span>).<span class="ident">next</span>().<span class="ident">unwrap</span>() {
            <span class="string">&quot;hour&quot;</span> <span class="op">=&gt;</span> {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Ok</span>(<span class="ident">val</span>) <span class="op">=</span> <span class="ident">value</span>.<span class="ident">parse</span>() {
                    <span class="ident">entry</span>.<span class="ident">hour</span> <span class="op">=</span> <span class="ident">val</span>;
                }
            },
            <span class="string">&quot;minute&quot;</span> <span class="op">=&gt;</span> {
                <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Ok</span>(<span class="ident">val</span>) <span class="op">=</span> <span class="ident">value</span>.<span class="ident">parse</span>() {
                    <span class="ident">entry</span>.<span class="ident">minute</span> <span class="op">=</span> <span class="ident">val</span>;
                }
            },
            <span class="string">&quot;repeat&quot;</span> <span class="op">=&gt;</span> {
                <span class="ident">entry</span>.<span class="ident">repeat</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">value</span>.<span class="ident">as_ref</span>() {
                    <span class="string">&quot;weekdays&quot;</span> <span class="op">=&gt;</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Weekdays</span>,
                    <span class="string">&quot;weekends&quot;</span> <span class="op">=&gt;</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Weekends</span>,
                    <span class="kw">_</span> <span class="op">=&gt;</span> <span class="ident">AlarmRepeat</span>::<span class="ident">Daily</span>,
                };
            },
            <span class="string">&quot;context&quot;</span> <span class="op">=&gt;</span> {
                <span class="ident">entry</span>.<span class="ident">context</span> <span class="op">=</span> <span class="ident">value</span>.<span class="ident">clone</span>();
            },
            <span class="string">&quot;device&quot;</span> <span class="op">=&gt;</span> {
                <span class="ident">entry</span>.<span class="ident">device</span> <span class="op">=</span> <span class="ident">value</span>.<span class="ident">clone</span>();
            },
            <span class="kw">_</span> <span class="op">=&gt;</span> {},
        }
    }
    <span class="kw">let</span> <span class="ident">entries</span> <span class="op">=</span> <span class="ident">entries</span>.<span class="ident">iter</span>().<span class="ident">filter</span>(<span class="op">|</span><span class="ident">e</span><span class="op">|</span> {
        <span class="op">!</span><span class="ident">e</span>.<span class="ident">context</span>.<span class="ident">is_empty</span>() <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="ident">e</span>.<span class="ident">device</span>.<span class="ident">is_empty</span>()
    }).<span class="ident">collect</span>::<span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="kw-2">&amp;</span><span class="ident">AlarmConfig</span><span class="op">&gt;&gt;</span>();
    <span class="kw">for</span> (<span class="ident">idx</span>,<span class="ident">entry</span>) <span class="kw">in</span> <span class="ident">entries</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>() {
        <span class="ident">conf</span>.<span class="ident">set_to</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;alarms&quot;</span>), <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;alarm{}&quot;</span>, <span class="ident">idx</span><span class="op">+</span><span class="number">1</span>), <span class="ident">entry</span>.<span class="ident">to_string</span>());
    }
    <span class="ident">conf</span>.<span class="ident">write_to_file</span>(<span class="kw-2">&amp;</span><span class="ident">file</span>).<span class="ident">unwrap</span>();
    <span class="prelude-val">Ok</span>(())
}

<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">read_settings</span>(<span class="ident">scopes_version</span>: <span class="ident">u32</span>) <span class="op">-&gt;</span> <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">Settings</span><span class="op">&gt;</span> {
    <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Attempting to read config file.&quot;</span>);
    <span class="kw">let</span> <span class="ident">conf</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">Ini</span>::<span class="ident">load_from_file</span>(<span class="kw-2">&amp;</span><span class="ident">inifile</span>()) {
        <span class="prelude-val">Ok</span>(<span class="ident">c</span>) <span class="op">=&gt;</span> <span class="ident">c</span>,
        <span class="prelude-val">Err</span>(<span class="ident">e</span>) <span class="op">=&gt;</span> {
            <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Load file error: {}&quot;</span>, <span class="ident">e</span>);
            <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;No config file found.&quot;</span>);
            <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Requesting settings via web form.&quot;</span>);
            <span class="comment">// Launch a local web server and open a browser to it.  Returns</span>
            <span class="comment">// the Spotify configuration.</span>
            <span class="kw">let</span> <span class="ident">web_config</span> <span class="op">=</span> <span class="ident">request_web_config</span>(<span class="prelude-val">None</span>);
            <span class="ident">save_web_config</span>(<span class="prelude-val">None</span>, <span class="ident">web_config</span>)
        }
    };

    <span class="kw">let</span> <span class="ident">section</span> <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;connectr&quot;</span>.<span class="ident">to_owned</span>())).<span class="ident">unwrap</span>();
    <span class="kw">let</span> <span class="ident">port</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;port&quot;</span>).<span class="ident">unwrap</span>().<span class="ident">parse</span>().<span class="ident">unwrap</span>();
    <span class="kw">let</span> <span class="ident">quicksave_default</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;quicksave_default&quot;</span>) {
        <span class="prelude-val">Some</span>(<span class="ident">uri</span>) <span class="op">=&gt;</span> <span class="prelude-val">Some</span>(<span class="ident">uri</span>.<span class="ident">to_string</span>()),
        <span class="prelude-val">None</span> <span class="op">=&gt;</span> <span class="prelude-val">None</span>,
    };

    <span class="kw">let</span> <span class="ident">section</span> <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;application&quot;</span>.<span class="ident">to_owned</span>())).<span class="ident">unwrap</span>();
    <span class="kw">let</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;secret&quot;</span>).<span class="ident">unwrap</span>();
    <span class="kw">let</span> <span class="ident">client_id</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;client_id&quot;</span>).<span class="ident">unwrap</span>();
    <span class="kw">if</span> <span class="ident">client_id</span>.<span class="ident">starts_with</span>(<span class="string">&#39;&lt;&#39;</span>) <span class="op">||</span> <span class="ident">secret</span>.<span class="ident">starts_with</span>(<span class="string">&#39;&lt;&#39;</span>) {
        <span class="macro">error</span><span class="macro">!</span>(<span class="string">&quot;Invalid or missing configuration.  Cannot continue.&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;ERROR: Spotify Client ID or Secret not set in connectr.ini!&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Create a Spotify application at https://developer.spotify.com/my-applications/ and&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;add the client ID and secret to connectr.ini.&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Be sure to add a redirect URI of http://127.0.0.1:&lt;PORT&gt; to your Spotify application,&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;and make sure the port matches in connectr.ini.&quot;</span>);
        <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>);
        <span class="kw">return</span> <span class="prelude-val">None</span>;
    }

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">access</span> <span class="op">=</span> <span class="prelude-val">None</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">refresh</span> <span class="op">=</span> <span class="prelude-val">None</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">expire_utc</span> <span class="op">=</span> <span class="prelude-val">None</span>;
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>) <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;tokens&quot;</span>.<span class="ident">to_owned</span>())) {
        <span class="kw">let</span> <span class="ident">saved_version</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;version&quot;</span>);
        <span class="comment">// Only accept saved tokens if the scopes version matches.  Otherwise</span>
        <span class="comment">// it will authenticate but some actions will be invalid.</span>
        <span class="kw">if</span> <span class="ident">saved_version</span>.<span class="ident">is_some</span>() <span class="op">&amp;&amp;</span>
            <span class="ident">saved_version</span>.<span class="ident">unwrap</span>().<span class="ident">parse</span>::<span class="op">&lt;</span><span class="ident">u32</span><span class="op">&gt;</span>().<span class="ident">unwrap</span>() <span class="op">==</span> <span class="ident">scopes_version</span> {
            <span class="ident">access</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;access&quot;</span>).<span class="ident">unwrap</span>().<span class="ident">clone</span>());
            <span class="ident">refresh</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;refresh&quot;</span>).<span class="ident">unwrap</span>().<span class="ident">clone</span>());
            <span class="ident">expire_utc</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;expire&quot;</span>).<span class="ident">unwrap</span>().<span class="ident">parse</span>().<span class="ident">unwrap</span>());
            <span class="macro">info</span><span class="macro">!</span>(<span class="string">&quot;Read access token from INI!&quot;</span>);
        }
    }

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">presets</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="op">&lt;</span>(<span class="ident">String</span>,<span class="ident">String</span>)<span class="op">&gt;</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">quicksave</span> <span class="op">=</span> <span class="ident">BTreeMap</span>::<span class="op">&lt;</span><span class="ident">String</span>,<span class="ident">String</span><span class="op">&gt;</span>::<span class="ident">new</span>();
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>) <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;presets&quot;</span>.<span class="ident">to_owned</span>())) {
        <span class="kw">for</span> (<span class="ident">key</span>, <span class="ident">value</span>) <span class="kw">in</span> <span class="ident">section</span> {
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">fields</span> <span class="op">=</span> <span class="ident">value</span>.<span class="ident">split</span>(<span class="string">&quot;,&quot;</span>);
            <span class="kw">let</span> <span class="ident">uri</span> <span class="op">=</span> <span class="ident">fields</span>.<span class="ident">next</span>().<span class="ident">unwrap</span>().<span class="ident">trim</span>(); <span class="comment">// URI is required</span>
            <span class="kw">let</span> <span class="ident">save_uri</span> <span class="op">=</span> <span class="ident">fields</span>.<span class="ident">next</span>(); <span class="comment">// quicksave is optional</span>
            <span class="ident">presets</span>.<span class="ident">push</span>((<span class="ident">key</span>.<span class="ident">to_owned</span>(), <span class="ident">uri</span>.<span class="ident">to_owned</span>()));
            <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">save_uri</span>) <span class="op">=</span> <span class="ident">save_uri</span> {
                <span class="ident">quicksave</span>.<span class="ident">insert</span>(<span class="ident">uri</span>.<span class="ident">to_owned</span>(), <span class="ident">save_uri</span>.<span class="ident">trim</span>().<span class="ident">to_owned</span>());
            }
        }
    }
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">alarms</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="op">&lt;</span><span class="ident">AlarmConfig</span><span class="op">&gt;</span>::<span class="ident">new</span>();
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>) <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;alarms&quot;</span>.<span class="ident">to_owned</span>())) {
        <span class="kw">for</span> (<span class="ident">_key</span>, <span class="ident">value</span>) <span class="kw">in</span> <span class="ident">section</span> {
            <span class="kw">match</span> <span class="ident">AlarmConfig</span>::<span class="ident">from_str</span>(<span class="ident">value</span>) {
                <span class="prelude-val">Ok</span>(<span class="ident">a</span>) <span class="op">=&gt;</span> <span class="ident">alarms</span>.<span class="ident">push</span>(<span class="ident">a</span>),
                <span class="prelude-val">Err</span>(<span class="kw">_</span>) <span class="op">=&gt;</span> {},
            }
        }
    }

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lastfm</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">LastfmSettings</span><span class="op">&gt;</span> <span class="op">=</span> <span class="prelude-val">None</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lastfm_enabled</span> <span class="op">=</span> <span class="bool-val">false</span>;
    <span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">section</span>) <span class="op">=</span> <span class="ident">conf</span>.<span class="ident">section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;lastfm&quot;</span>.<span class="ident">to_owned</span>())) {
        <span class="kw">let</span> <span class="ident">enabled</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;enabled&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;false&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">key</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;key&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">secret</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;secret&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">session_key</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;session_key&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">username</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;username&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">ignore_pc</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;ignore_pc&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;false&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="kw">let</span> <span class="ident">ignore_phone</span> <span class="op">=</span> <span class="ident">section</span>.<span class="ident">get</span>(<span class="string">&quot;ignore_phone&quot;</span>).<span class="ident">unwrap_or</span>(<span class="kw-2">&amp;</span><span class="string">&quot;false&quot;</span>.<span class="ident">to_string</span>()).<span class="ident">clone</span>();
        <span class="ident">lastfm_enabled</span> <span class="op">=</span> <span class="ident">enabled</span> <span class="op">==</span> <span class="string">&quot;true&quot;</span>;
        <span class="ident">lastfm</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">LastfmSettings</span> {
            <span class="ident">key</span>: <span class="ident">key</span>,
            <span class="ident">secret</span>: <span class="ident">secret</span>,
            <span class="ident">session_key</span>: <span class="ident">session_key</span>,
            <span class="ident">username</span>: <span class="ident">username</span>,
            <span class="ident">ignore_pc</span>: <span class="ident">ignore_pc</span> <span class="op">==</span> <span class="string">&quot;true&quot;</span>,
            <span class="ident">ignore_phone</span>: <span class="ident">ignore_phone</span> <span class="op">==</span> <span class="string">&quot;true&quot;</span>,
        });
    }

    <span class="prelude-val">Some</span>(<span class="ident">Settings</span> { <span class="ident">secret</span>: <span class="ident">secret</span>.<span class="ident">to_string</span>(), <span class="ident">client_id</span>: <span class="ident">client_id</span>.<span class="ident">to_string</span>(), <span class="ident">port</span>: <span class="ident">port</span>,
                    <span class="ident">access_token</span>: <span class="ident">access</span>, <span class="ident">refresh_token</span>: <span class="ident">refresh</span>, <span class="ident">expire_utc</span>: <span class="ident">expire_utc</span>,
                    <span class="ident">presets</span>: <span class="ident">presets</span>,
                    <span class="ident">default_quicksave</span>: <span class="ident">quicksave_default</span>,
                    <span class="ident">quicksave</span>: <span class="ident">quicksave</span>,
                    <span class="ident">alarms</span>: <span class="ident">alarms</span>,
                    <span class="ident">lastfm_enabled</span>: <span class="ident">lastfm_enabled</span>,
                    <span class="ident">lastfm</span>: <span class="ident">lastfm</span>,
    })
}

<span class="kw">pub</span> <span class="kw">type</span> <span class="ident">SettingsError</span> <span class="op">=</span> <span class="ident">String</span>;
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">save_tokens</span>(<span class="ident">version</span>: <span class="ident">u32</span>, <span class="ident">access</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>,
                   <span class="ident">refresh</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>, <span class="ident">expire_utc</span>: <span class="ident">u64</span>) <span class="op">-&gt;</span> <span class="prelude-ty">Result</span><span class="op">&lt;</span>(), <span class="ident">SettingsError</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">conf</span> <span class="op">=</span> <span class="ident">Ini</span>::<span class="ident">load_from_file</span>(<span class="kw-2">&amp;</span><span class="ident">inifile</span>()).<span class="ident">unwrap</span>();
    <span class="ident">conf</span>.<span class="ident">with_section</span>(<span class="prelude-val">Some</span>(<span class="string">&quot;tokens&quot;</span>.<span class="ident">to_owned</span>()))
        .<span class="ident">set</span>(<span class="string">&quot;access&quot;</span>, <span class="ident">access</span>)
        .<span class="ident">set</span>(<span class="string">&quot;refresh&quot;</span>, <span class="ident">refresh</span>)
        .<span class="ident">set</span>(<span class="string">&quot;version&quot;</span>, <span class="macro">format</span><span class="macro">!</span>(<span class="string">&quot;{}&quot;</span>,<span class="ident">version</span>))
        .<span class="ident">set</span>(<span class="string">&quot;expire&quot;</span>, <span class="ident">expire_utc</span>.<span class="ident">to_string</span>());
    <span class="ident">conf</span>.<span class="ident">write_to_file</span>(<span class="kw-2">&amp;</span><span class="ident">inifile</span>()).<span class="ident">unwrap</span>();
    <span class="prelude-val">Ok</span>(())
}
</pre>
</section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <aside id="help" class="hidden">
        <div>
            <h1 class="hidden">Help</h1>

            <div class="shortcuts">
                <h2>Keyboard Shortcuts</h2>

                <dl>
                    <dt><kbd>?</kbd></dt>
                    <dd>Show this help dialog</dd>
                    <dt><kbd>S</kbd></dt>
                    <dd>Focus the search field</dd>
                    <dt><kbd>↑</kbd></dt>
                    <dd>Move up in search results</dd>
                    <dt><kbd>↓</kbd></dt>
                    <dd>Move down in search results</dd>
                    <dt><kbd>↹</kbd></dt>
                    <dd>Switch tab</dd>
                    <dt><kbd>&#9166;</kbd></dt>
                    <dd>Go to active search result</dd>
                    <dt><kbd>+</kbd></dt>
                    <dd>Expand all sections</dd>
                    <dt><kbd>-</kbd></dt>
                    <dd>Collapse all sections</dd>
                </dl>
            </div>

            <div class="infos">
                <h2>Search Tricks</h2>

                <p>
                    Prefix searches with a type followed by a colon (e.g.
                    <code>fn:</code>) to restrict the search to a given type.
                </p>

                <p>
                    Accepted types are: <code>fn</code>, <code>mod</code>,
                    <code>struct</code>, <code>enum</code>,
                    <code>trait</code>, <code>type</code>, <code>macro</code>,
                    and <code>const</code>.
                </p>

                <p>
                    Search functions by type signature (e.g.
                    <code>vec -> usize</code> or <code>* -> vec</code>)
                </p>
            </div>
        </div>
    </aside>

    

    <script>
        window.rootPath = "../../../";
        window.currentCrate = "connectr";
    </script>
    <script src="../../../main.js"></script>
    <script defer src="../../../search-index.js"></script>
</body>
</html>